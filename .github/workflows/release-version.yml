name: release-version

on:
  workflow_run:
    workflows:
      - CI
    types:
      - completed

permissions:
  actions: write
  contents: write

concurrency:
  group: release-version-main
  cancel-in-progress: false

jobs:
  bump-and-tag:
    if: |
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'push' &&
      github.event.workflow_run.head_branch == 'main' &&
      !startsWith(github.event.workflow_run.head_commit.message, 'chore(release): bump version to')
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ github.token }}
      REPO: ${{ github.repository }}

    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Configure git author
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Compute next patch version (from latest git tag)
        id: version
        run: |
          set -euo pipefail

          latest="$(git tag --list 'v*' --sort=-v:refname | head -n 1 || true)"
          if [[ -z "${latest}" ]]; then
            latest="v0.0.0"
          fi

          current="${latest#v}"
          IFS='.' read -r major minor patch <<< "${current}"
          next="${major}.${minor}.$((patch + 1))"
          tag="v${next}"

          echo "latest_tag=${latest}" >> "${GITHUB_OUTPUT}"
          echo "current=${current}" >> "${GITHUB_OUTPUT}"
          echo "next=${next}" >> "${GITHUB_OUTPUT}"
          echo "tag=${tag}" >> "${GITHUB_OUTPUT}"

      - name: Skip if target tag already exists
        id: exists
        run: |
          set -euo pipefail
          if git ls-remote --exit-code --tags origin "refs/tags/${{ steps.version.outputs.tag }}" >/dev/null; then
            echo "tag_exists=true" >> "${GITHUB_OUTPUT}"
            echo "tag ${{ steps.version.outputs.tag }} already exists; skipping."
          else
            echo "tag_exists=false" >> "${GITHUB_OUTPUT}"
          fi

      - name: Create release tag
        if: steps.exists.outputs.tag_exists != 'true'
        run: |
          set -euo pipefail
          tag="${{ steps.version.outputs.tag }}"
          sha="${{ github.event.workflow_run.head_sha }}"

          if git ls-remote --exit-code --tags origin "refs/tags/${tag}" >/dev/null; then
            echo "tag ${tag} already exists; nothing to do."
            exit 0
          fi

          # Ensure the target commit is present in the checkout.
          git fetch --no-tags origin "${sha}" || true

          git tag -a "${tag}" "${sha}" -m "Release ${tag}"
          git push origin "refs/tags/${tag}"

      - name: Trigger publishes for release tag
        if: steps.exists.outputs.tag_exists != 'true'
        run: |
          set -euo pipefail
          tag="${{ steps.version.outputs.tag }}"
          # Tags pushed by workflows do not reliably trigger tag-push workflows, so dispatch explicitly.
          gh workflow run publish-platform-images.yml --repo "${REPO}" --ref "${tag}"
          gh workflow run publish-foundry.yml --repo "${REPO}" --ref "${tag}"

      - name: Workflow summary
        run: |
          set -euo pipefail
          {
            echo "## Automated Release Tag"
            echo ""
            echo "- Source workflow run: [${{ github.event.workflow_run.id }}](${{ github.event.workflow_run.html_url }})"
            echo "- Latest tag: \`${{ steps.version.outputs.latest_tag }}\`"
            echo "- Next version: \`${{ steps.version.outputs.next }}\`"
            if [[ "${{ steps.exists.outputs.tag_exists }}" == "true" ]]; then
              echo "- Result: skipped (tag already existed)"
            else
              echo "- Git tag: \`${{ steps.version.outputs.tag }}\`"
              echo "- Tagged commit: \`${{ github.event.workflow_run.head_sha }}\`"
            fi
          } >> "${GITHUB_STEP_SUMMARY}"
